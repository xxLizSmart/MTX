import{c as ce,r as t,f as le,j as e,g as de,b as ue,u as me,d as pe,a as he,h as fe,e as y,i as ge,B as N,T as xe}from"./index-bc28f289.js";import{H as je}from"./Helmet-2bae2f2d.js";import{C as Y,a as ye,b as ve,c as we}from"./card-d5d390a5.js";import{I as be}from"./input-e21fa800.js";import{L as $}from"./label-c69623d7.js";import{S as P,a as W,b as K,c as O,d as z}from"./select-cee25cc1.js";import{D as Ce,a as Se,b as Ne,c as _e,d as Te,e as $e}from"./dialog-37e5da2f.js";import{T as De}from"./TransactionsHistory-9c933f05.js";import{A as Ae}from"./alert-triangle-84971450.js";import"./table-90bdd3a0.js";const Ee=ce("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]]),ke=({symbol:v,assetType:S="crypto"})=>{const f=t.useRef(null),{theme:i}=le();return t.useEffect(()=>{if(!f.current||f.current.querySelector("script"))return;const o=document.createElement("script");o.src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js",o.type="text/javascript",o.async=!0;let w;S==="stock"?(w=`NASDAQ:${v.toUpperCase()}`,`${v.toUpperCase()}`):(w=`BINANCE:${v.toUpperCase()}USDT`,`${v.toUpperCase()}`);const b={allow_symbol_change:!0,calendar:!1,details:!1,hide_side_toolbar:!0,hide_top_toolbar:!1,hide_legend:!1,hide_volume:!1,hotlist:!1,interval:"D",locale:"en",save_image:!0,style:"1",symbol:w,theme:i,timezone:"Etc/UTC",backgroundColor:i==="dark"?"#0F0F0F":"hsl(240, 10%, 99%)",gridColor:i==="dark"?"rgba(242, 242, 242, 0.06)":"rgba(42, 46, 57, 0.06)",watchlist:[],withdateranges:!1,compareSymbols:[],studies:["STD;Bollinger_Bands"],autosize:!0};for(o.innerHTML=JSON.stringify(b);f.current.firstChild;)f.current.removeChild(f.current.firstChild);f.current.appendChild(o)},[v,i,S]),e.jsx("div",{className:"tradingview-widget-container",style:{height:"100%",width:"100%"},ref:f,children:e.jsx("div",{className:"tradingview-widget-container__widget",style:{height:"100%",width:"100%"}})})},Ie=t.memo(ke),We=()=>{var V,q;const{symbol:v="btc"}=de(),S=ue(),{t:f}=me(),{toast:i}=pe(),{user:o,userProfile:w}=he();fe();const[b,Q]=t.useState(!1),[C,J]=t.useState({}),[c,X]=t.useState(v),[h,U]=t.useState(!1),[l,G]=t.useState("30"),[_,F]=t.useState(0),[a,Z]=t.useState(null),[R,D]=t.useState(!1),[A,ee]=t.useState(""),[E,se]=t.useState([]),[m,k]=t.useState("USDT"),[te,B]=t.useState(!0),[g,re]=t.useState({}),[ae,ne]=t.useState(!1);t.useState(0);const L=t.useCallback(async()=>{B(!0);try{const[{data:s,error:r},{data:n,error:d}]=await Promise.all([y.from("assets").select("name, symbol, price, icon_url"),y.from("trade_settings").select("*")]);if(r)throw new Error(`Assets Error: ${r.message}`);if(d&&d.code!=="42P01")throw new Error(`Settings Error: ${d.message}`);const u=(s||[]).reduce((j,p)=>(j[p.symbol.toLowerCase()]={name:p.name,price:p.price,icon:p.icon_url},j),{});J(u);const x=(n||[]).reduce((j,p)=>(j[p.duration]=p,j),{});re(x),w&&Q(w.kyc_status==="approved")}catch(s){console.error(s),i({variant:"destructive",title:"Initialization Error",description:s.message})}finally{B(!1)}},[i,w]),I=t.useCallback(async()=>{if(!o)return;const{data:s,error:r}=await y.from("user_assets").select("symbol, amount").eq("user_id",o.id);if(r)i({variant:"destructive",title:"Failed to fetch balances",description:r.message});else{const n=s.map(u=>({currency:u.symbol,amount:u.amount}));se(n),n.find(u=>u.currency==="USDT")?k("USDT"):n.length>0&&k(n[0].currency)}},[o,i]);t.useEffect(()=>{L()},[L]),t.useEffect(()=>{Object.keys(C).length>0&&I()},[C,I]),t.useEffect(()=>{let s;return h&&_>0?s=setInterval(()=>F(r=>r-1),1e3):h&&_===0&&ie(),()=>clearInterval(s)},[h,_]);const M=s=>{var u;if(!b){i({variant:"destructive",title:"KYC Required",description:"Please complete KYC verification to start trading."});return}const r=parseFloat(A),n=((u=E.find(x=>x.currency===m))==null?void 0:u.amount)||0,d=g[l];if(!r||r<=0){i({variant:"destructive",title:"Invalid Amount",description:"Please enter a valid amount."});return}if(d&&r<d.min_capital){i({variant:"destructive",title:"Capital Too Low",description:`Minimum capital for ${l}s is ${d.min_capital} ${m}.`});return}if(r>n){i({variant:"destructive",title:"Insufficient Balance",description:`You do not have enough ${m}.`});return}U(!0),F(parseInt(l)),i({title:"Trade Started!",description:`You placed a ${s} trade for ${r} ${m} over ${l} seconds.`})},ie=async()=>{var H;U(!1);const s=g[l],r=parseFloat(A);let n;const{data:d,error:u}=await y.from("profiles").select("trade_override_status").eq("id",o.id).single();u&&console.error("User fetch error",u),d&&d.trade_override_status?n=d.trade_override_status==="win":n=Math.random()<((s==null?void 0:s.win_rate)||.5);const x=n?r*((s==null?void 0:s.win_rate)||.8):-(r*((s==null?void 0:s.loss_rate)||1)),{error:j}=await y.from("transactions").insert({user_id:o.id,type:"trade",status:n?"win":"loss",from_symbol:m,to_symbol:m,from_amount:r,to_amount:x,fee:0,price:((H=C[c])==null?void 0:H.price)||0,notes:`${l}s trade on ${c.toUpperCase()} - ${n?"WIN":"LOSS"}`});j&&console.error("Transaction log error",j);const{data:p}=await y.from("user_assets").select("*").eq("user_id",o.id).eq("symbol",m).maybeSingle();if(p){const T=Math.max(0,parseFloat(p.amount)+x);await y.from("user_assets").update({amount:T}).eq("id",p.id)}else x>0&&await y.from("user_assets").insert({user_id:o.id,symbol:m,amount:x});Z({win:n,profit:x,currency:m}),D(!0),I(),ne(T=>!T)},oe=s=>["aapl","tsla","googl"].includes(s.toLowerCase());return te?e.jsx("div",{className:"flex justify-center items-center h-screen",children:e.jsx(ge,{className:"h-10 w-10 animate-spin"})}):e.jsxs(e.Fragment,{children:[e.jsx(je,{children:e.jsx("title",{children:`${f("trading")} ${c.toUpperCase()} - MetaTradeX`})}),e.jsxs("div",{className:"bg-transparent text-foreground p-2 sm:p-4",children:[e.jsxs("div",{className:"grid grid-cols-12 gap-4",children:[e.jsx("div",{className:"col-span-12 lg:col-span-9",children:e.jsxs(Y,{className:"glassmorphic overflow-hidden p-0",children:[e.jsxs("div",{className:"p-4 border-b border-border/50 flex items-center gap-4",children:[((V=C[c])==null?void 0:V.icon)&&e.jsx("img",{src:C[c].icon,alt:c,className:"w-8 h-8"}),e.jsxs("h2",{className:"text-xl font-bold",children:[((q=C[c])==null?void 0:q.name)||c.toUpperCase()," (",c.toUpperCase(),")"]})]}),e.jsx("div",{className:"h-[calc(75vh-80px)] w-full",children:e.jsx(Ie,{symbol:c,assetType:oe(c)?"stock":"crypto"},c)})]})}),e.jsx("div",{className:"col-span-12 lg:col-span-3 space-y-4",children:e.jsxs(Y,{className:"glassmorphic",children:[e.jsx(ye,{children:e.jsx(ve,{children:"Trade Panel"})}),e.jsxs(we,{className:"space-y-4",children:[!b&&e.jsxs("div",{className:"flex items-center gap-2 p-3 rounded-lg bg-yellow-400/10 text-yellow-500 border border-yellow-400/20",children:[e.jsx(Ae,{className:"h-5 w-5"}),e.jsx("p",{className:"text-xs",children:"KYC required for trading."}),e.jsx(N,{size:"sm",variant:"link",className:"p-0 h-auto text-yellow-500",onClick:()=>S("/kyc"),children:"Verify Now"})]}),h&&e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-muted-foreground",children:"Time Remaining"}),e.jsxs("p",{className:"text-4xl font-bold font-mono",children:[_,"s"]})]}),e.jsxs("div",{children:[e.jsx($,{children:"Select Asset"}),e.jsxs(P,{value:c,onValueChange:s=>{X(s),S(`/trading/${s}`)},disabled:h,children:[e.jsx(W,{children:e.jsx(K,{})}),e.jsx(O,{children:Object.entries(C).map(([s,r])=>e.jsxs(z,{value:s,children:[r.name," (",s.toUpperCase(),")"]},s))})]})]}),e.jsxs("div",{children:[e.jsx($,{children:"Duration"}),e.jsx("div",{className:"grid grid-cols-4 gap-2 mt-2",children:Object.keys(g).sort((s,r)=>parseInt(s)-parseInt(r)).map(s=>e.jsxs(N,{variant:l===s?"default":"outline",onClick:()=>G(s),disabled:h,children:[s,"s"]},s))})]}),e.jsxs("div",{children:[e.jsx($,{children:"Trade With"}),E.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"No balances found"}):e.jsxs(P,{value:m,onValueChange:k,disabled:h,children:[e.jsx(W,{children:e.jsx(K,{})}),e.jsx(O,{children:E.map(s=>e.jsxs(z,{value:s.currency,children:[s.currency," (",parseFloat(s.amount).toFixed(4),")"]},s.currency))})]})]}),e.jsxs("div",{children:[e.jsx($,{htmlFor:"amount",children:`Amount (${m})`}),e.jsx(be,{id:"amount",type:"number",value:A,onChange:s=>ee(s.target.value),disabled:h||!b,placeholder:g[l]?`Min: ${g[l].min_capital}`:"Enter amount"})]}),e.jsx("div",{className:"text-center text-sm text-muted-foreground",children:g[l]?`Win: +${(g[l].win_rate*100).toFixed(0)}%`:"Select a duration"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs(N,{className:"bg-green-500 hover:bg-green-600 text-white h-12 flex items-center justify-center gap-2",onClick:()=>M("buy"),disabled:h||!b||!g[l],children:[e.jsx(xe,{className:"h-5 w-5"})," Buy"]}),e.jsxs(N,{className:"bg-red-500 hover:bg-red-600 text-white h-12 flex items-center justify-center gap-2",onClick:()=>M("sell"),disabled:h||!b||!g[l],children:[e.jsx(Ee,{className:"h-5 w-5"})," Sell"]})]})]})]})})]}),e.jsx("div",{className:"mt-8",children:e.jsx(De,{},ae)})]}),e.jsx(Ce,{open:R,onOpenChange:D,children:e.jsxs(Se,{children:[e.jsxs(Ne,{children:[e.jsx(_e,{children:a!=null&&a.win?"Congratulations! You Won!":"Trade Ended."}),e.jsx(Te,{children:a!=null&&a.win?`You made a profit of ${a==null?void 0:a.profit.toFixed(6)} ${a==null?void 0:a.currency}.`:`You lost ${Math.abs(a==null?void 0:a.profit).toFixed(6)} ${a==null?void 0:a.currency}.`})]}),e.jsx($e,{children:e.jsx(N,{onClick:()=>D(!1),children:"Close"})})]})})]})};export{We as default};
