import{c as ce,r as t,f as le,j as e,g as de,u as ue,a as me,d as pe,b as he,h as fe,e as v,i as ge,B as _,T as xe}from"./index-d9a06326.js";import{H as je}from"./Helmet-90a894cc.js";import{C as q,a as ve,b as ye,d as we}from"./card-308cff17.js";import{I as be}from"./input-d1fd22f3.js";import{L as D}from"./label-b53f8564.js";import{S as H,a as O,b as W,c as K,d as z}from"./select-e0fceac2.js";import{D as Ce,a as Se,b as Ne,c as _e,d as Te,e as $e}from"./dialog-8e203f57.js";import{T as De}from"./TransactionsHistory-1eb2e0be.js";import{C as Ee}from"./cryptoPrices-f92ea880.js";import{A as Ae}from"./alert-triangle-4db9a4f5.js";import"./table-2c457f8d.js";import"./arrow-left-8866a27f.js";import"./arrow-right-6bb328b6.js";const ke=ce("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]]),Ie=({symbol:y,assetType:N="crypto"})=>{const f=t.useRef(null),{theme:i}=le();return t.useEffect(()=>{if(!f.current||f.current.querySelector("script"))return;const o=document.createElement("script");o.src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js",o.type="text/javascript",o.async=!0;let w;N==="stock"?(w=`NASDAQ:${y.toUpperCase()}`,`${y.toUpperCase()}`):(w=`BINANCE:${y.toUpperCase()}USDT`,`${y.toUpperCase()}`);const b={allow_symbol_change:!0,calendar:!1,details:!1,hide_side_toolbar:!0,hide_top_toolbar:!1,hide_legend:!1,hide_volume:!1,hotlist:!1,interval:"D",locale:"en",save_image:!0,style:"1",symbol:w,theme:i,timezone:"Etc/UTC",backgroundColor:i==="dark"?"#0F0F0F":"hsl(240, 10%, 99%)",gridColor:i==="dark"?"rgba(242, 242, 242, 0.06)":"rgba(42, 46, 57, 0.06)",watchlist:[],withdateranges:!1,compareSymbols:[],studies:["STD;Bollinger_Bands"],autosize:!0};for(o.innerHTML=JSON.stringify(b);f.current.firstChild;)f.current.removeChild(f.current.firstChild);f.current.appendChild(o)},[y,i,N]),e.jsx("div",{className:"tradingview-widget-container",style:{height:"100%",width:"100%"},ref:f,children:e.jsx("div",{className:"tradingview-widget-container__widget",style:{height:"100%",width:"100%"}})})},Ue=t.memo(Ie),Qe=()=>{var V,Y;const{symbol:y="btc"}=de(),N=ue(),{t:f}=me(),{toast:i}=pe(),{user:o,userProfile:w}=he();fe();const[b,Q]=t.useState(!1),[C,J]=t.useState({}),[c,X]=t.useState(y),[h,F]=t.useState(!1),[l,G]=t.useState("30"),[T,B]=t.useState(0),[a,Z]=t.useState(null),[R,E]=t.useState(!1),[A,ee]=t.useState(""),[k,se]=t.useState([]),[p,I]=t.useState("USDT"),[te,L]=t.useState(!0),[g,re]=t.useState({}),[ae,ne]=t.useState(!1);t.useState(0);const M=t.useCallback(async()=>{L(!0);try{const[{data:s,error:r},{data:n,error:m}]=await Promise.all([v.from("assets").select("name, symbol, price, icon_url"),v.from("trade_settings").select("*")]);if(r)throw new Error(`Assets Error: ${r.message}`);if(m&&m.code!=="42P01")throw new Error(`Settings Error: ${m.message}`);const d=Object.entries(Ee).reduce((u,[j,S])=>(u[j.toLowerCase()]={name:S.name,price:S.price,icon:S.icon_url},u),{});(s||[]).forEach(u=>{d[u.symbol.toLowerCase()]={name:u.name,price:u.price,icon:u.icon_url}}),J(d);const x=(n||[]).reduce((u,j)=>(u[j.duration]=j,u),{});re(x),w&&Q(w.kyc_status==="approved")}catch(s){console.error(s),i({variant:"destructive",title:"Initialization Error",description:s.message})}finally{L(!1)}},[i,w]),U=t.useCallback(async()=>{if(!o)return;const{data:s,error:r}=await v.from("user_assets").select("symbol, amount").eq("user_id",o.id);if(r)i({variant:"destructive",title:"Failed to fetch balances",description:r.message});else{const n=s.map(d=>({currency:d.symbol,amount:d.amount}));se(n),n.find(d=>d.currency==="USDT")?I("USDT"):n.length>0&&I(n[0].currency)}},[o,i]);t.useEffect(()=>{M()},[M]),t.useEffect(()=>{Object.keys(C).length>0&&U()},[C,U]),t.useEffect(()=>{let s;return h&&T>0?s=setInterval(()=>B(r=>r-1),1e3):h&&T===0&&ie(),()=>clearInterval(s)},[h,T]);const P=s=>{var d;if(!b){i({variant:"destructive",title:"KYC Required",description:"Please complete KYC verification to start trading."});return}const r=parseFloat(A),n=((d=k.find(x=>x.currency===p))==null?void 0:d.amount)||0,m=g[l];if(!r||r<=0){i({variant:"destructive",title:"Invalid Amount",description:"Please enter a valid amount."});return}if(m&&r<m.min_capital){i({variant:"destructive",title:"Capital Too Low",description:`Minimum capital for ${l}s is ${m.min_capital} ${p}.`});return}if(r>n){i({variant:"destructive",title:"Insufficient Balance",description:`You do not have enough ${p}.`});return}F(!0),B(parseInt(l)),i({title:"Trade Started!",description:`You placed a ${s} trade for ${r} ${p} over ${l} seconds.`})},ie=async()=>{var S;F(!1);const s=g[l],r=parseFloat(A);let n;const{data:m,error:d}=await v.from("profiles").select("trade_override_status").eq("id",o.id).single();d&&console.error("User fetch error",d),m&&m.trade_override_status?n=m.trade_override_status==="win":n=Math.random()<((s==null?void 0:s.win_rate)||.5);const x=n?r*((s==null?void 0:s.win_rate)||.8):-(r*((s==null?void 0:s.loss_rate)||1)),{error:u}=await v.from("transactions").insert({user_id:o.id,type:"trade",status:n?"win":"loss",from_symbol:p,to_symbol:p,from_amount:r,to_amount:x,fee:0,price:((S=C[c])==null?void 0:S.price)||0,notes:`${l}s trade on ${c.toUpperCase()} - ${n?"WIN":"LOSS"}`});u&&console.error("Transaction log error",u);const{data:j}=await v.from("user_assets").select("*").eq("user_id",o.id).eq("symbol",p).maybeSingle();if(j){const $=Math.max(0,parseFloat(j.amount)+x);await v.from("user_assets").update({amount:$}).eq("id",j.id)}else x>0&&await v.from("user_assets").insert({user_id:o.id,symbol:p,amount:x});Z({win:n,profit:x,currency:p}),E(!0),U(),ne($=>!$)},oe=s=>["aapl","tsla","googl"].includes(s.toLowerCase());return te?e.jsx("div",{className:"flex justify-center items-center h-screen",children:e.jsx(ge,{className:"h-10 w-10 animate-spin"})}):e.jsxs(e.Fragment,{children:[e.jsx(je,{children:e.jsx("title",{children:`${f("trading")} ${c.toUpperCase()} - MetaTradeX`})}),e.jsxs("div",{className:"bg-transparent text-foreground p-2 sm:p-4",children:[e.jsxs("div",{className:"grid grid-cols-12 gap-4",children:[e.jsx("div",{className:"col-span-12 lg:col-span-9",children:e.jsxs(q,{className:"glassmorphic overflow-hidden p-0",children:[e.jsxs("div",{className:"p-4 border-b border-border/50 flex items-center gap-4",children:[((V=C[c])==null?void 0:V.icon)&&e.jsx("img",{src:C[c].icon,alt:c,className:"w-8 h-8"}),e.jsxs("h2",{className:"text-xl font-bold",children:[((Y=C[c])==null?void 0:Y.name)||c.toUpperCase()," (",c.toUpperCase(),")"]})]}),e.jsx("div",{className:"h-[50vh] lg:h-[calc(75vh-80px)] w-full",children:e.jsx(Ue,{symbol:c,assetType:oe(c)?"stock":"crypto"},c)})]})}),e.jsx("div",{className:"col-span-12 lg:col-span-3 space-y-4",children:e.jsxs(q,{className:"glassmorphic",children:[e.jsx(ve,{children:e.jsx(ye,{children:"Trade Panel"})}),e.jsxs(we,{className:"space-y-4",children:[!b&&e.jsxs("div",{className:"flex items-center gap-2 p-3 rounded-lg bg-yellow-400/10 text-yellow-500 border border-yellow-400/20",children:[e.jsx(Ae,{className:"h-5 w-5"}),e.jsx("p",{className:"text-xs",children:"KYC required for trading."}),e.jsx(_,{size:"sm",variant:"link",className:"p-0 h-auto text-yellow-500",onClick:()=>N("/kyc"),children:"Verify Now"})]}),h&&e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-muted-foreground",children:"Time Remaining"}),e.jsxs("p",{className:"text-4xl font-bold font-mono",children:[T,"s"]})]}),e.jsxs("div",{children:[e.jsx(D,{children:"Select Asset"}),e.jsxs(H,{value:c,onValueChange:s=>{X(s),N(`/trading/${s}`)},disabled:h,children:[e.jsx(O,{children:e.jsx(W,{})}),e.jsx(K,{children:Object.entries(C).map(([s,r])=>e.jsxs(z,{value:s,children:[r.name," (",s.toUpperCase(),")"]},s))})]})]}),e.jsxs("div",{children:[e.jsx(D,{children:"Duration"}),e.jsx("div",{className:"grid grid-cols-4 gap-2 mt-2",children:Object.keys(g).sort((s,r)=>parseInt(s)-parseInt(r)).map(s=>e.jsxs(_,{variant:l===s?"default":"outline",onClick:()=>G(s),disabled:h,children:[s,"s"]},s))})]}),e.jsxs("div",{children:[e.jsx(D,{children:"Trade With"}),k.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"No balances found"}):e.jsxs(H,{value:p,onValueChange:I,disabled:h,children:[e.jsx(O,{children:e.jsx(W,{})}),e.jsx(K,{children:k.map(s=>e.jsxs(z,{value:s.currency,children:[s.currency," (",parseFloat(s.amount).toFixed(4),")"]},s.currency))})]})]}),e.jsxs("div",{children:[e.jsx(D,{htmlFor:"amount",children:`Amount (${p})`}),e.jsx(be,{id:"amount",type:"number",value:A,onChange:s=>ee(s.target.value),disabled:h||!b,placeholder:g[l]?`Min: ${g[l].min_capital}`:"Enter amount"})]}),e.jsx("div",{className:"text-center text-sm text-muted-foreground",children:g[l]?`Win: +${(g[l].win_rate*100).toFixed(0)}%`:"Select a duration"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs(_,{className:"bg-green-500 hover:bg-green-600 text-white h-12 flex items-center justify-center gap-2",onClick:()=>P("buy"),disabled:h||!b||!g[l],children:[e.jsx(xe,{className:"h-5 w-5"})," Buy"]}),e.jsxs(_,{className:"bg-red-500 hover:bg-red-600 text-white h-12 flex items-center justify-center gap-2",onClick:()=>P("sell"),disabled:h||!b||!g[l],children:[e.jsx(ke,{className:"h-5 w-5"})," Sell"]})]})]})]})})]}),e.jsx("div",{className:"mt-8",children:e.jsx(De,{},ae)})]}),e.jsx(Ce,{open:R,onOpenChange:E,children:e.jsxs(Se,{children:[e.jsxs(Ne,{children:[e.jsx(_e,{children:a!=null&&a.win?"Congratulations! You Won!":"Trade Ended."}),e.jsx(Te,{children:a!=null&&a.win?`You made a profit of ${a==null?void 0:a.profit.toFixed(6)} ${a==null?void 0:a.currency}.`:`You lost ${Math.abs(a==null?void 0:a.profit).toFixed(6)} ${a==null?void 0:a.currency}.`})]}),e.jsx($e,{children:e.jsx(_,{onClick:()=>E(!1),children:"Close"})})]})})]})};export{Qe as default};
