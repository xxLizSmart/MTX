import{c as R,u as V,d as D,a as Y,r as l,e as i,j as e,B as _,i as O}from"./index-bc28f289.js";import{H as P}from"./Helmet-2bae2f2d.js";import{C as X,a as G,b as J,c as K}from"./card-d5d390a5.js";import{I as F}from"./input-e21fa800.js";import{L as A}from"./label-c69623d7.js";import{S as E,a as k,b as B,c as L,d as q}from"./select-cee25cc1.js";const Q=R("ArrowRightLeft",[["path",{d:"m16 3 4 4-4 4",key:"1x1c3m"}],["path",{d:"M20 7H4",key:"zbl0bi"}],["path",{d:"m8 21-4-4 4-4",key:"h9nckh"}],["path",{d:"M4 17h16",key:"g4d7ey"}]]),ae=()=>{var g,v;const{t:j}=V(),{toast:d}=D(),{user:c}=Y(),[m,T]=l.useState([]),[t,p]=l.useState(""),[o,x]=l.useState(""),[n,I]=l.useState(1),[u,b]=l.useState(0),[w,f]=l.useState(!1),[h,$]=l.useState({}),y=l.useCallback(async()=>{f(!0);try{const[{data:s,error:a},{data:r,error:C}]=await Promise.all([i.from("assets").select("*"),i.from("user_assets").select("symbol, amount").eq("user_id",c.id)]);if(a)throw a;if(C)throw C;T(s),s.length>1&&(p(s[0].symbol),x(s[1].symbol));const z=r.reduce((S,N)=>(S[N.symbol]=N.amount,S),{});$(z)}catch{d({variant:"destructive",title:"Error",description:"Could not load necessary data."})}finally{f(!1)}},[d,c.id]);l.useEffect(()=>{y()},[y]),l.useEffect(()=>{if(m.length>0&&n>0&&t&&o){const s=m.find(r=>r.symbol===t),a=m.find(r=>r.symbol===o);if(s&&a){const r=s.price/a.price*n;b(r.toFixed(8))}}else b(0)},[t,o,n,m]);const H=async()=>{f(!0);const s=h[t]||0;if(n>s){d({variant:"destructive",title:"Insufficient Balance",description:`You don't have enough ${t}.`}),f(!1);return}try{const{data:a}=await i.from("user_assets").select("*").eq("user_id",c.id).eq("symbol",t).single(),{data:r}=await i.from("user_assets").select("*").eq("user_id",c.id).eq("symbol",o).maybeSingle();if(!a)throw new Error("Source asset not found");await i.from("user_assets").update({amount:parseFloat(a.amount)-parseFloat(n)}).eq("id",a.id),r?await i.from("user_assets").update({amount:parseFloat(r.amount)+parseFloat(u)}).eq("id",r.id):await i.from("user_assets").insert({user_id:c.id,symbol:o,amount:u}),await i.from("transactions").insert({user_id:c.id,type:"swap",status:"completed",from_symbol:t,to_symbol:o,from_amount:n,to_amount:u}),d({title:"Swap Successful!",description:`You swapped ${n} ${t} for ${u} ${o}.`}),y()}catch(a){d({variant:"destructive",title:"Swap Failed",description:a.message})}finally{f(!1)}},M=()=>{const s=t;p(o),x(s)};return e.jsxs(e.Fragment,{children:[e.jsx(P,{children:e.jsxs("title",{children:[j("swap")," - MetaTradeX"]})}),e.jsx("div",{className:"container mx-auto p-4 sm:p-6 lg:p-8 flex justify-center items-center min-h-[calc(100vh-4rem)]",children:e.jsxs(X,{className:"w-full max-w-md glassmorphic",children:[e.jsx(G,{children:e.jsx(J,{className:"text-center text-3xl font-bold",children:j("swap")})}),e.jsxs(K,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(A,{children:"From"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Balance: ",((g=h[t])==null?void 0:g.toFixed(4))||"0.00"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(F,{type:"number",value:n,onChange:s=>I(s.target.value),className:"w-2/3"}),e.jsxs(E,{value:t,onValueChange:p,children:[e.jsx(k,{className:"w-1/3",children:e.jsx(B,{})}),e.jsx(L,{children:m.map(s=>e.jsx(q,{value:s.symbol,children:s.symbol},s.symbol))})]})]})]}),e.jsx("div",{className:"flex justify-center",children:e.jsx(_,{variant:"ghost",size:"icon",onClick:M,children:e.jsx(Q,{className:"h-5 w-5 text-muted-foreground"})})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(A,{children:"To"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Balance: ",((v=h[o])==null?void 0:v.toFixed(4))||"0.00"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(F,{type:"number",value:u,readOnly:!0,className:"w-2/3 bg-muted"}),e.jsxs(E,{value:o,onValueChange:x,children:[e.jsx(k,{className:"w-1/3",children:e.jsx(B,{})}),e.jsx(L,{children:m.map(s=>e.jsx(q,{value:s.symbol,children:s.symbol},s.symbol))})]})]})]}),e.jsx(_,{onClick:H,className:"w-full !mt-8",size:"lg",disabled:w||!n||n<=0,children:w?e.jsxs(e.Fragment,{children:[e.jsx(O,{className:"mr-2 h-4 w-4 animate-spin"})," Swapping..."]}):"Swap Coins"})]})]})})]})};export{ae as default};
