import{c as P,a as Y,d as z,b as D,r as l,e as c,j as e,B as F,i as V}from"./index-d9a06326.js";import{H as U}from"./Helmet-90a894cc.js";import{C as X,a as G,b as J,d as K}from"./card-308cff17.js";import{I as A}from"./input-d1fd22f3.js";import{L as E}from"./label-b53f8564.js";import{S as T,a as L,b as k,c as B,d as q}from"./select-e0fceac2.js";import{C as Q}from"./cryptoPrices-f92ea880.js";const W=P("ArrowRightLeft",[["path",{d:"m16 3 4 4-4 4",key:"1x1c3m"}],["path",{d:"M20 7H4",key:"zbl0bi"}],["path",{d:"m8 21-4-4 4-4",key:"h9nckh"}],["path",{d:"M4 17h16",key:"g4d7ey"}]]),Z=Object.entries(Q).map(([p,i])=>({symbol:p,name:i.name,price:i.price,icon_url:i.icon_url})),le=()=>{var C,S;const{t:p}=Y(),{toast:i}=z(),{user:m}=D(),[d,I]=l.useState([]),[t,h]=l.useState(""),[o,j]=l.useState(""),[n,R]=l.useState(1),[u,w]=l.useState(0),[g,f]=l.useState(!1),[y,$]=l.useState({}),b=l.useCallback(async()=>{f(!0);try{const[{data:s,error:a},{data:r,error:v}]=await Promise.all([c.from("assets").select("*"),c.from("user_assets").select("symbol, amount").eq("user_id",m.id)]);if(a)throw a;if(v)throw v;const x=s&&s.length>0?s:Z;I(x),x.length>1&&!t&&(h(x[0].symbol),j(x[1].symbol));const O=r.reduce((N,_)=>(N[_.symbol]=_.amount,N),{});$(O)}catch{i({variant:"destructive",title:"Error",description:"Could not load necessary data."})}finally{f(!1)}},[i,m.id]);l.useEffect(()=>{b()},[b]),l.useEffect(()=>{if(d.length>0&&n>0&&t&&o){const s=d.find(r=>r.symbol===t),a=d.find(r=>r.symbol===o);if(s&&a){const r=s.price/a.price*n;w(r.toFixed(8))}}else w(0)},[t,o,n,d]);const H=async()=>{f(!0);const s=y[t]||0;if(n>s){i({variant:"destructive",title:"Insufficient Balance",description:`You don't have enough ${t}.`}),f(!1);return}try{const{data:a}=await c.from("user_assets").select("*").eq("user_id",m.id).eq("symbol",t).single(),{data:r}=await c.from("user_assets").select("*").eq("user_id",m.id).eq("symbol",o).maybeSingle();if(!a)throw new Error("Source asset not found");await c.from("user_assets").update({amount:parseFloat(a.amount)-parseFloat(n)}).eq("id",a.id),r?await c.from("user_assets").update({amount:parseFloat(r.amount)+parseFloat(u)}).eq("id",r.id):await c.from("user_assets").insert({user_id:m.id,symbol:o,amount:u}),await c.from("transactions").insert({user_id:m.id,type:"swap",status:"completed",from_symbol:t,to_symbol:o,from_amount:n,to_amount:u}),i({title:"Swap Successful!",description:`You swapped ${n} ${t} for ${u} ${o}.`}),b()}catch(a){i({variant:"destructive",title:"Swap Failed",description:a.message})}finally{f(!1)}},M=()=>{const s=t;h(o),j(s)};return e.jsxs(e.Fragment,{children:[e.jsx(U,{children:e.jsxs("title",{children:[p("swap")," - MetaTradeX"]})}),e.jsx("div",{className:"container mx-auto p-4 sm:p-6 lg:p-8 flex justify-center items-center min-h-[calc(100vh-4rem)]",children:e.jsxs(X,{className:"w-full max-w-md glassmorphic",children:[e.jsx(G,{children:e.jsx(J,{className:"text-center text-3xl font-bold",children:p("swap")})}),e.jsxs(K,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(E,{children:"From"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Balance: ",((C=y[t])==null?void 0:C.toFixed(4))||"0.00"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(A,{type:"number",value:n,onChange:s=>R(s.target.value),className:"w-2/3"}),e.jsxs(T,{value:t,onValueChange:h,children:[e.jsx(L,{className:"w-1/3",children:e.jsx(k,{})}),e.jsx(B,{children:d.map(s=>e.jsx(q,{value:s.symbol,children:s.symbol},s.symbol))})]})]})]}),e.jsx("div",{className:"flex justify-center",children:e.jsx(F,{variant:"ghost",size:"icon",onClick:M,children:e.jsx(W,{className:"h-5 w-5 text-muted-foreground"})})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(E,{children:"To"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Balance: ",((S=y[o])==null?void 0:S.toFixed(4))||"0.00"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(A,{type:"number",value:u,readOnly:!0,className:"w-2/3 bg-muted"}),e.jsxs(T,{value:o,onValueChange:j,children:[e.jsx(L,{className:"w-1/3",children:e.jsx(k,{})}),e.jsx(B,{children:d.map(s=>e.jsx(q,{value:s.symbol,children:s.symbol},s.symbol))})]})]})]}),e.jsx(F,{onClick:H,className:"w-full !mt-8",size:"lg",disabled:g||!n||n<=0,children:g?e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"mr-2 h-4 w-4 animate-spin"})," Swapping..."]}):"Swap Coins"})]})]})})]})};export{le as default};
